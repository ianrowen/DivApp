# Google OAuth Troubleshooting for Development Builds

## Quick Diagnostic Steps

### 1. Check Console Logs
When you try to sign in, look for these log messages:
```
[Supabase] Generated dev build redirect URI: divin8://supabase-auth
[Supabase] Platform: iOS/Android
[Supabase] App ownership: standalone
```

### 2. Check What Error You're Getting

**Common errors and fixes:**

#### Error: "redirect_uri_mismatch"
- **Cause**: The redirect URI in Google Cloud Console doesn't match what Supabase is sending
- **Fix**: 
  1. Check the console log for the exact redirect URI being generated
  2. In Google Cloud Console → OAuth 2.0 Client ID → Authorized redirect URIs
  3. Add: `https://bawkzybwbpoxftgawvha.supabase.co/auth/v1/callback`
  4. **Important**: Google doesn't accept custom schemes directly. Supabase handles the redirect.

#### Error: "unauthorized_client"
- **Cause**: OAuth Client ID mismatch or not configured
- **Fix**:
  1. Go to Supabase Dashboard → Authentication → Providers → Google
  2. Copy the Client ID and Client Secret
  3. Verify they match Google Cloud Console → Credentials → OAuth 2.0 Client ID

#### Error: "access_denied" or User Cancelled
- **Cause**: User cancelled the OAuth flow
- **Fix**: This is normal user behavior, not a config issue

#### No Error, But Login Doesn't Complete
- **Cause**: Redirect URI not configured in Supabase
- **Fix**:
  1. Go to Supabase Dashboard → Authentication → Providers → Google
  2. In "Redirect URLs" section, add:
     - `divin8://supabase-auth`
     - `com.divin8.app://supabase-auth` (for Android)
  3. Save changes

### 3. Platform-Specific Issues

#### iOS
- The redirect URI should be: `divin8://supabase-auth`
- Verify in `app.json` that `ios.infoPlist.CFBundleURLSchemes` includes `divin8`
- Rebuild the app after making changes

#### Android
- The redirect URI might be: `divin8://supabase-auth` or `com.divin8.app://supabase-auth`
- Check `AndroidManifest.xml` has the intent filter for `divin8` scheme
- Verify `app.json` → `android.package` is `com.divin8.app`

### 4. Verify Configuration Checklist

- [ ] Supabase Dashboard → Authentication → Providers → Google → Redirect URLs includes `divin8://supabase-auth`
- [ ] Google Cloud Console → OAuth 2.0 Client ID → Authorized redirect URIs includes `https://bawkzybwbpoxftgawvha.supabase.co/auth/v1/callback`
- [ ] Supabase Google Provider has correct Client ID and Client Secret from Google Cloud Console
- [ ] App scheme in `app.json` is `divin8`
- [ ] Development build was rebuilt after configuration changes

### 5. Test the Redirect URI

Add this temporary code to verify the redirect URI:

```typescript
import { makeRedirectUri } from 'expo-auth-session';
import Constants from 'expo-constants';

const testRedirect = makeRedirectUri({
  scheme: 'divin8',
  path: 'supabase-auth',
});
console.log('Test redirect URI:', testRedirect);
console.log('Platform:', Constants.platform);
```

### 6. Common Mistakes

1. **Adding custom scheme to Google Cloud Console** ❌
   - Don't add `divin8://supabase-auth` to Google Cloud Console
   - Google only accepts HTTPS URLs
   - Add the Supabase callback URL instead: `https://bawkzybwbpoxftgawvha.supabase.co/auth/v1/callback`

2. **Not rebuilding after config changes** ❌
   - Configuration changes require a rebuild
   - Run: `eas build --profile development --platform ios/android`

3. **Wrong redirect URI in Supabase** ❌
   - Must match exactly what's generated by `makeRedirectUri`
   - Check console logs for the exact format

### 7. Still Not Working?

1. **Check Supabase Auth Logs**:
   - Go to Supabase Dashboard → Logs → Auth logs
   - Look for errors related to OAuth

2. **Check Google Cloud Console Logs**:
   - Go to Google Cloud Console → APIs & Services → Credentials
   - Check OAuth consent screen configuration

3. **Verify Environment Variables**:
   - Make sure `EXPO_PUBLIC_SUPABASE_URL` and `EXPO_PUBLIC_SUPABASE_ANON_KEY` are set
   - Check `eas.json` has these in the development profile

4. **Try Expo Go First**:
   - Test with Expo Go to verify the OAuth flow works
   - If it works in Expo Go but not dev build, it's a redirect URI configuration issue

## Need More Help?

Share these details:
1. Platform (iOS/Android)
2. Exact error message from console logs
3. The redirect URI shown in console logs: `[Supabase] Generated dev build redirect URI: ...`
4. Whether you've configured both Supabase and Google Cloud Console



