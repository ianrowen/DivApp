<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Reset Password - Divin8</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Prevent FOUC - hide content until fonts load */
        body {
            visibility: hidden;
        }
        body.fonts-loaded {
            visibility: visible;
        }
    </style>
    <!-- CRITICAL: Extract tokens/code BEFORE Supabase SDK loads to prevent auto-verification -->
    <script>
        // Debug logging configuration - disable in production to prevent localhost popups
        window.__DEBUG_LOGGING_ENABLED__ = false; // Set to false to disable debug logging
        
        // Helper function for debug logging (only logs if enabled)
        function debugLog(location, message, data, hypothesisId) {
            if (!window.__DEBUG_LOGGING_ENABLED__) {
                return; // Logging disabled
            }
            try {
                fetch('http://127.0.0.1:7242/ingest/428b75af-757e-429a-aaa1-d11d73a7516d', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: location,
                        message: message,
                        data: data || {},
                        timestamp: Date.now(),
                        sessionId: 'debug-session',
                        runId: 'run1',
                        hypothesisId: hypothesisId || ''
                    })
                }).catch(function() {});
            } catch (e) {
                // Silently fail
            }
        }
        
        // Extract tokens from URL hash OR code from query params IMMEDIATELY, before any other scripts run
        // Store them in a global variable so they're available after SDK loads
        (function() {
            'use strict';
            // Prevent double execution
            if (window.__TOKENS_EXTRACTED__) {
                return;
            }
            window.__TOKENS_EXTRACTED__ = true;
            
            var hash = window.location.hash.substring(1);
            var search = window.location.search.substring(1);
            var fullUrl = window.location.href;
            
            // #region agent log
            debugLog('reset-password.html:19', 'URL extraction entry', {fullUrl:fullUrl,hashLength:hash.length,searchLength:search.length,pathname:window.location.pathname}, 'A,B,C');
            // #endregion
            
            var hashParams = hash ? new URLSearchParams(hash) : null;
            var searchParams = search ? new URLSearchParams(search) : null;
            
            // Check for tokens in hash first (standard password reset flow)
            var accessToken = hashParams ? hashParams.get('access_token') : null;
            var type = hashParams ? hashParams.get('type') : null;
            var refreshToken = hashParams ? hashParams.get('refresh_token') : null;
            
            // Also check for code OR token in query params (alternative flow)
            // Supabase might use 'code' or 'token' parameter name
            var code = searchParams ? searchParams.get('code') : null;
            var tokenParam = searchParams ? searchParams.get('token') : null;
            
            // Check for error parameters that Supabase might add (in hash OR query params)
            // Supabase redirects errors in hash: #error=...&error_code=...
            var errorParam = hashParams ? hashParams.get('error') : null;
            var errorDescription = hashParams ? hashParams.get('error_description') : null;
            var errorCode = hashParams ? hashParams.get('error_code') : null;
            
            // Also check query params for errors (fallback)
            if (!errorParam && searchParams) {
                errorParam = searchParams.get('error');
                errorDescription = searchParams.get('error_description');
                errorCode = searchParams.get('error_code');
            }
            
            // Log all query parameters for debugging
            var allQueryParams = {};
            if (searchParams) {
                searchParams.forEach(function(value, key) {
                    allQueryParams[key] = value.substring(0, 50) + (value.length > 50 ? '...' : ''); // Truncate long values
                });
            }
            
            // Log all hash parameters for debugging
            var allHashParams = {};
            if (hashParams) {
                hashParams.forEach(function(value, key) {
                    allHashParams[key] = value.substring(0, 50) + (value.length > 50 ? '...' : ''); // Truncate long values
                });
            }
            
            // Use token parameter if code is not found
            if (!code && tokenParam) {
                code = tokenParam;
            }
            
            // Check for errors FIRST before processing tokens/code
            if (errorParam) {
                // Error detected - store it and skip token/code processing
                window.__PASSWORD_RESET_ERROR__ = {
                    error: errorParam,
                    error_description: errorDescription,
                    error_code: errorCode
                };
                console.log('Error detected in URL:', errorParam, errorDescription);
                console.log('Error code:', errorCode);
            // #region agent log
            debugLog('reset-password.html:74', 'Error detected in initial script - skipping token/code processing', {error:errorParam,errorDescription:errorDescription,errorCode:errorCode,fromHash:!!hashParams&&hashParams.has('error'),fromQuery:!!searchParams&&searchParams.has('error'),allHashParams:allHashParams}, 'G');
            // #endregion
                // Don't process tokens/code if error is present
                window.__PASSWORD_RESET_TOKENS__ = null;
                window.__PASSWORD_RESET_CODE__ = null;
                return; // Exit early, error will be handled by main script
            }
            
            // #region agent log
            debugLog('reset-password.html:88', 'Token extraction results', {hasHash:!!hash,hasSearch:!!search,hasAccessToken:!!accessToken,type:type,hasCode:!!code,hasTokenParam:!!tokenParam,accessTokenLength:accessToken?accessToken.length:0,codeLength:code?code.length:0,allQueryParams:allQueryParams}, 'A,B,C,G');
            // #endregion
            
            console.log('Token/code extraction:', {
                hasHash: !!hash,
                hasSearch: !!search,
                hasAccessToken: !!accessToken,
                type: type,
                hasCode: !!code
            });
            
            // Try to decode JWT to check expiration (if token exists)
            var tokenExpiration = null;
            if (accessToken) {
                try {
                    var tokenParts = accessToken.split('.');
                    if (tokenParts.length === 3) {
                        var payload = JSON.parse(atob(tokenParts[1]));
                        tokenExpiration = payload.exp ? new Date(payload.exp * 1000) : null;
                        var now = new Date();
                        var isExpired = tokenExpiration && tokenExpiration < now;
                            // #region agent log
                            debugLog('reset-password.html:109', 'Token expiration check', {tokenExpiration:tokenExpiration?tokenExpiration.toISOString():null,currentTime:now.toISOString(),isExpired:isExpired,expSeconds:payload.exp,iatSeconds:payload.iat}, 'A,C');
                            // #endregion
                    }
                } catch (e) {
                    // #region agent log
                    debugLog('reset-password.html:116', 'Token decode error', {error:e.message}, 'A,C');
                    // #endregion
                }
            }
            
            if (accessToken && type === 'recovery') {
                // Standard password reset flow: tokens in hash
                // Redirect to app deep link with tokens so app can handle password reset
                const appDeepLink = `divin8://reset-password?access_token=${encodeURIComponent(accessToken)}&type=recovery${refreshToken ? '&refresh_token=' + encodeURIComponent(refreshToken) : ''}`;
                console.log('Tokens received, redirecting to app:', appDeepLink);
                window.location.href = appDeepLink;
                return; // Exit early, app will handle the rest
            } else if (code) {
                // Alternative flow: code in query params
                // Extract the code but don't clear it yet - we'll handle it manually
                window.__PASSWORD_RESET_CODE__ = code;
                console.log('Code found in query params - will handle manually');
            } else {
                window.__PASSWORD_RESET_TOKENS__ = null;
                window.__PASSWORD_RESET_CODE_FOUND__ = false;
                console.log('No tokens or code found in URL');
            }
        })();
    </script>
    <!-- Load Supabase SDK AFTER tokens are extracted and URL is cleared -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Mark fonts as loaded to prevent FOUC
        document.fonts.ready.then(function() {
            document.body.classList.add('fonts-loaded');
        });
        // Fallback if fonts.ready doesn't fire
        setTimeout(function() {
            document.body.classList.add('fonts-loaded');
        }, 100);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000000;
            background-image: linear-gradient(135deg, #0A0A0A 0%, #1A0A14 30%, #2D0A1F 70%, #0A0A0A 100%);
            color: #C0C0C0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            width: 100%;
            background: rgba(10, 10, 10, 0.95);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(139, 21, 56, 0.3);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo img {
            max-width: 200px;
            height: auto;
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-family: 'Cinzel', serif;
            font-size: 32px;
            color: #D4AF37;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .logo p {
            font-family: 'Lato', sans-serif;
            color: #C0C0C0;
            font-size: 14px;
        }
        
        .status {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status.loading {
            background: rgba(212, 175, 55, 0.1);
            color: #d4af37;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }
        
        .status.error {
            background: rgba(107, 15, 15, 0.2);
            color: #D4AF37;
            border: 1px solid rgba(107, 15, 15, 0.5);
        }
        
        .spinner {
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-top: 3px solid #d4af37;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #D4AF37;
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            font-size: 14px;
        }
        
        input[type="password"] {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            color: #C0C0C0;
            font-family: 'Lato', sans-serif;
            font-size: 16px;
        }
        
        input[type="password"]:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }
        
        .button {
            width: 100%;
            padding: 14px;
            background: #D4AF37;
            color: #000000;
            border: none;
            border-radius: 8px;
            font-family: 'Lato', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .button:hover {
            background: #B8941F;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .button-secondary {
            background: transparent;
            color: #D4AF37;
            border: 1px solid #D4AF37;
            margin-top: 10px;
        }
        
        .button-secondary:hover {
            background: rgba(212, 175, 55, 0.1);
        }
        
        .info {
            text-align: center;
            color: #C0C0C0;
            margin: 20px 0;
            font-family: 'Lato', sans-serif;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Ensure success div is hidden by default */
        #success {
            display: none;
        }
        
        #success:not(.hidden) {
            display: block;
        }
        
        .error-message {
            color: #D4AF37;
            font-family: 'Lato', sans-serif;
            font-size: 14px;
            margin-top: 10px;
        }
        
        h2 {
            font-family: 'Cinzel', serif;
            color: #D4AF37;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="https://divin8.com/assets/images/logo/divin8-card-curtains-horizontal.png" alt="Divin8 Logo" onerror="this.style.display='none';">
            <h1>Divin8</h1>
            <p>Mystical Divination</p>
        </div>
        
        <div id="loading" class="status loading">
            <div class="spinner"></div>
            <div style="margin-top: 12px;">Processing password reset...</div>
        </div>
        
        <div id="resetForm" class="hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">Reset Your Password</h2>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" name="newPassword" required minlength="6" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6" placeholder="Confirm new password">
                </div>
                <div id="errorMessage" class="error-message hidden"></div>
                <button type="submit" class="button" id="submitButton">Reset Password</button>
            </form>
            <a href="https://divin8.com" class="button button-secondary" style="display: block; text-align: center; text-decoration: none;">Cancel</a>
        </div>
        
        <div id="success" class="hidden">
            <div class="status success">
                ✅ Password reset successful!
            </div>
            <div class="info">
                Your password has been reset. You can now sign in with your new password.
            </div>
            <a href="https://divin8.com" class="button button-secondary" style="display: block; text-align: center; text-decoration: none; margin-top: 20px;">Return to Website</a>
        </div>
        
        <div id="error" class="hidden">
            <div class="status error">
                ❌ Invalid or expired password reset link
            </div>
            <div class="info">
                This password reset link is invalid or has expired. Please request a new password reset.
            </div>
            <a href="https://divin8.com" class="button button-secondary" style="display: block; text-align: center; text-decoration: none; margin-top: 20px;">Return to Website</a>
        </div>
    </div>

    <script>
        // Prevent double execution - wrap everything in IIFE
        (function() {
            'use strict';
            
            // Guard against double execution
            if (window.__PASSWORD_RESET_PROCESSED__) {
                console.warn('Password reset script already executed, skipping');
                return;
            }
            window.__PASSWORD_RESET_PROCESSED__ = true;
            
            // Initialize Supabase client
            // IMPORTANT: Update SUPABASE_ANON_KEY with your actual anon key from Supabase Dashboard → Settings → API
            // The anon key is safe to use in client-side code (it's public by design)
            const SUPABASE_URL = 'https://bawkzybwbpoxftgawvha.supabase.co';
            // TODO: Replace with your actual Supabase anon key from .env file (EXPO_PUBLIC_SUPABASE_ANON_KEY)
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhd2t6eWJ3YnBveGZ0Z2F3dmhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTI3NzcsImV4cCI6MjA3Nzg4ODc3N30.GLRosL14pt3gpYLh8Yde3n_Eh0e_8vyB_8PYlhg2juc';
            
            if (SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.querySelector('#error .info').textContent = 'Configuration error: Please update SUPABASE_ANON_KEY in reset-password.html with your actual Supabase anon key.';
                return;
            }
        
        // Get tokens/code/error that were checked BEFORE SDK loaded
        const tokens = window.__PASSWORD_RESET_TOKENS__;
        const code = window.__PASSWORD_RESET_CODE__;
        let error = window.__PASSWORD_RESET_ERROR__;
        
        // Also check hash directly for errors (in case error wasn't stored properly)
        if (!error) {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const hashParams = new URLSearchParams(hash);
                const errorParam = hashParams.get('error');
                if (errorParam) {
                    error = {
                        error: errorParam,
                        error_description: hashParams.get('error_description'),
                        error_code: hashParams.get('error_code')
                    };
                    // #region agent log
                    debugLog('reset-password.html:355', 'Error detected in hash (fallback check)', {error:error.error,errorCode:error.error_code,errorDescription:error.error_description}, 'G');
                    // #endregion
                }
            }
        }
        
        // Initialize Supabase client with auto-detection DISABLED
        // We'll handle everything manually to prevent SDK from trying to verify the code
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                detectSessionInUrl: false, // CRITICAL: Disable auto-detection to prevent SDK from verifying code
                persistSession: false, // Don't persist session during reset
                autoRefreshToken: false, // Disable auto-refresh
                storage: {
                    getItem: function() { return null; },
                    setItem: function() {},
                    removeItem: function() {}
                }
            }
        });
        
        console.log('Password reset page loaded', {
            hasTokens: !!tokens,
            hasCode: !!code
        });
        
        // #region agent log
                        debugLog('reset-password.html:320', 'Page script execution started', {hasTokens:!!tokens,hasCode:!!code,currentUrl:window.location.href}, 'A,B,C,D,F');
        // #endregion
        
        // Clean up global variables
        if (window.__PASSWORD_RESET_TOKENS__) {
            delete window.__PASSWORD_RESET_TOKENS__;
        }
        if (window.__PASSWORD_RESET_CODE__) {
            delete window.__PASSWORD_RESET_CODE__;
        }
        
        if (tokens && tokens.access_token && tokens.type === 'recovery') {
            // Standard flow: tokens in hash - set session manually
            // #region agent log
            debugLog('reset-password.html:333', 'Attempting setSession with tokens', {hasAccessToken:!!tokens.access_token,hasRefreshToken:!!tokens.refresh_token,type:tokens.type,accessTokenLength:tokens.access_token.length}, 'A,C,D');
            // #endregion
            supabase.auth.setSession({
                access_token: tokens.access_token,
                refresh_token: tokens.refresh_token || ''
            }).then(({ data, error }) => {
                document.getElementById('loading').classList.add('hidden');
                
                if (error) {
                    // #region agent log
                    debugLog('reset-password.html:341', 'setSession error', {message:error.message,status:error.status,code:error.code,name:error.name,isExpiredError:error.message.includes('expired')||error.message.includes('Expired')||error.code==='token_expired'}, 'A,C,D');
                    // #endregion
                    console.error('Error exchanging code for session:', error);
                    console.error('Error details:', {
                        message: error.message,
                        status: error.status,
                        code: error.code
                    });
                    document.getElementById('error').classList.remove('hidden');
                } else if (data.session) {
                    // #region agent log
                    debugLog('reset-password.html:349', 'Session established successfully', {hasSession:!!data.session,userId:data.session?.user?.id,expiresAt:data.session?.expires_at}, 'A,C,D');
                    // #endregion
                    console.log('Session established successfully via tokens');
                    showPasswordResetForm(supabase);
                } else {
                    // #region agent log
                    debugLog('reset-password.html:353', 'No session returned from setSession', {hasData:!!data,hasError:!!error}, 'A,C,D');
                    // #endregion
                    console.error('No session returned from setSession');
                    document.getElementById('error').classList.remove('hidden');
                }
            }).catch((err) => {
                // #region agent log
                debugLog('reset-password.html:356', 'Exception in setSession', {message:err.message,name:err.name,stack:err.stack}, 'A,C,D');
                // #endregion
                console.error('Exception in setSession:', err);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
            });
        } else if (code) {
            // Check if this is a PKCE token hash (starts with 'pkce_') or a UUID code
            const isPkceToken = code && typeof code === 'string' && code.startsWith('pkce_');
            
            // #region agent log
            debugLog('reset-password.html:437', 'Code/token detected - checking type', {codeLength:code?code.length:0,isPkceToken:isPkceToken,codePrefix:code?code.substring(0,20):'null',codeType:typeof code,currentUrl:window.location.href}, 'H');
            // #endregion
            
            console.log('Code detected:', { code: code ? code.substring(0, 30) + '...' : 'null', isPkceToken, codeType: typeof code });
            
            if (isPkceToken) {
                // PKCE token hash flow: Use verifyOtp directly with token_hash
                console.log('PKCE token hash detected - using verifyOtp');
                console.log('Token hash:', code);
                
                // #region agent log
                debugLog('reset-password.html:445', 'Using verifyOtp for PKCE token', {tokenHashLength:code.length}, 'H');
                // #endregion
                
                // Use verifyOtp with token_hash for PKCE tokens
                // CRITICAL: For PKCE tokens, we use verifyOtp with token_hash parameter
                console.log('Calling verifyOtp with token_hash for PKCE token');
                
                // #region agent log
                debugLog('reset-password.html:500', 'Calling verifyOtp for PKCE token', {tokenHashLength:code.length,tokenHashPrefix:code.substring(0,20)}, 'H');
                // #endregion
                
                supabase.auth.verifyOtp({
                    token_hash: code,
                    type: 'recovery'
                }).then(({ data, error }) => {
                    // #region agent log
                    debugLog('reset-password.html:505', 'verifyOtp response', {hasError:!!error,hasSession:!!data?.session,errorMessage:error?.message,errorCode:error?.code,errorStatus:error?.status,userId:data?.session?.user?.id}, 'H');
                    // #endregion
                    
                    document.getElementById('loading').classList.add('hidden');
                    
                    if (error) {
                        console.error('verifyOtp error:', error);
                        console.error('Error details:', {
                            message: error.message,
                            status: error.status,
                            code: error.code
                        });
                        document.getElementById('error').classList.remove('hidden');
                    } else if (data.session) {
                        console.log('Session established successfully via verifyOtp');
                        showPasswordResetForm(supabase);
                    } else {
                        console.error('No session returned from verifyOtp');
                        document.getElementById('error').classList.remove('hidden');
                    }
                }).catch((err) => {
                    // #region agent log
                    debugLog('reset-password.html:461', 'Exception in verifyOtp', {message:err.message,name:err.name}, 'H');
                    // #endregion
                    console.error('Exception in verifyOtp:', err);
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('error').classList.remove('hidden');
                });
            } else {
                // UUID code flow: Exchange via /verify endpoint
                console.log('UUID code detected - navigating to verify endpoint');
                console.log('Code:', code);
                
                // Use exact redirect URL that matches Supabase configuration
                // CRITICAL: This MUST match exactly what's in Supabase Dashboard → Authentication → URL Configuration → Redirect URLs
                const redirectTo = 'https://divin8.com/reset-password.html';
                
                // Build verify URL - use 'token' parameter name (Supabase expects 'token' not 'code' in verify endpoint)
                const verifyUrl = `${SUPABASE_URL}/auth/v1/verify?token=${encodeURIComponent(code)}&type=recovery&redirect_to=${encodeURIComponent(redirectTo)}`;
                
                console.log('Verify URL:', verifyUrl);
                console.log('Redirect to:', redirectTo);
                
                // #region agent log
                debugLog('reset-password.html:477', 'Navigating to verify endpoint for UUID code', {verifyUrl:verifyUrl,redirectTo:redirectTo,codeLength:code.length}, 'F,G');
                // #endregion
                
                // Navigate to verify endpoint - Supabase will exchange code for tokens and redirect back with tokens in hash
                // The page will reload and tokens will be extracted in the initial script
                window.location.href = verifyUrl;
                return; // Exit early, page will reload with tokens in hash
            }
        } else if (error && error.error) {
            // Error parameters found in URL (from Supabase redirect)
            // #region agent log
            debugLog('reset-password.html:514', 'Error parameters detected in main script', {error:error.error,errorCode:error.error_code,errorDescription:error.error_description,currentUrl:window.location.href}, 'G');
            // #endregion
            
            console.error('Supabase error detected:', error.error, error.error_description);
            console.error('Error code:', error.error_code);
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            
            // Update error message with details from Supabase
            var errorInfo = document.querySelector('#error .info');
            if (errorInfo) {
                var errorMsg = 'This password reset link is invalid or has expired.';
                if (error.error_description) {
                    errorMsg = decodeURIComponent(error.error_description.replace(/\+/g, ' '));
                }
                errorInfo.textContent = errorMsg + ' Please request a new password reset.';
            }
            
            // Clean up error from window
            if (window.__PASSWORD_RESET_ERROR__) {
                delete window.__PASSWORD_RESET_ERROR__;
            }
        } else {
            // No tokens, code, or error found
            // #region agent log
            debugLog('reset-password.html:495', 'No tokens or code found', {hasTokens:!!tokens,hasCode:!!code,hasError:!!error,currentUrl:window.location.href}, 'B');
            // #endregion
            
            console.error('No recovery tokens or code found in URL');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
        }
        
        // Function to show password reset form and handle submission
        function showPasswordResetForm(supabase) {
            // Session established, show password reset form
            // Ensure success and error divs are hidden
            document.getElementById('success').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('resetForm').classList.remove('hidden');
            
            // Handle form submission (only attach once - check if already attached)
            const form = document.getElementById('passwordForm');
            if (form.dataset.listenerAttached === 'true') {
                return; // Already attached
            }
            form.dataset.listenerAttached = 'true';
            
            form.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        const newPassword = document.getElementById('newPassword').value;
                        const confirmPassword = document.getElementById('confirmPassword').value;
                        const errorMessage = document.getElementById('errorMessage');
                        const submitButton = document.getElementById('submitButton');
                        
                        // Ensure success div is hidden before showing form errors
                        document.getElementById('success').classList.add('hidden');
                        
                        // Clear previous errors
                        errorMessage.classList.add('hidden');
                        errorMessage.textContent = '';
                        
                        // Validate passwords
                        if (newPassword.length < 6) {
                            errorMessage.textContent = 'Password must be at least 6 characters long';
                            errorMessage.classList.remove('hidden');
                            return;
                        }
                        
                        if (newPassword !== confirmPassword) {
                            errorMessage.textContent = 'Passwords do not match';
                            errorMessage.classList.remove('hidden');
                            return;
                        }
                        
                        // Disable button
                        submitButton.disabled = true;
                        submitButton.textContent = 'Resetting...';
                        
                        // Update password using the established session
                        // #region agent log
                        debugLog('reset-password.html:414', 'Attempting password update', {passwordLength:newPassword.length}, 'A,C,D');
                        // #endregion
                        const { error: updateError } = await supabase.auth.updateUser({
                            password: newPassword
                        });
                        
                        if (updateError) {
                            // #region agent log
                            debugLog('reset-password.html:418', 'Password update error', {message:updateError.message,code:updateError.code,isExpiredError:updateError.message.includes('expired')||updateError.message.includes('Expired')||updateError.code==='token_expired'}, 'A,C,D');
                            // #endregion
                            console.error('Password update error:', updateError);
                            errorMessage.textContent = updateError.message || 'Failed to reset password. The link may have expired.';
                            errorMessage.classList.remove('hidden');
                            submitButton.disabled = false;
                            submitButton.textContent = 'Reset Password';
                        } else {
                            // Success - show success message
                            // #region agent log
                            debugLog('reset-password.html:425', 'Password reset successful', {}, 'A,C,D');
                            // #endregion
                            console.log('Password reset successful');
                            // Hide form and error, show success
                            document.getElementById('resetForm').classList.add('hidden');
                            document.getElementById('error').classList.add('hidden');
                            document.getElementById('loading').classList.add('hidden');
                            document.getElementById('success').classList.remove('hidden');
                        }
                    });
        }
        })(); // End IIFE
    </script>
</body>
</html>
