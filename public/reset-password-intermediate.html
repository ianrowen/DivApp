<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Redirecting - Divin8</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000000;
            background-image: linear-gradient(135deg, #0A0A0A 0%, #1A0A14 30%, #2D0A1F 70%, #0A0A0A 100%);
            color: #C0C0C0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            width: 100%;
            background: rgba(10, 10, 10, 0.95);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(139, 21, 56, 0.3);
            border: 1px solid rgba(212, 175, 55, 0.2);
            text-align: center;
        }
        
        .logo {
            margin-bottom: 30px;
        }
        
        .logo img {
            max-width: 200px;
            height: auto;
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-family: 'Cinzel', serif;
            font-size: 32px;
            color: #D4AF37;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 1px;
        }
        
        .logo p {
            font-family: 'Lato', sans-serif;
            color: #C0C0C0;
            font-size: 14px;
        }
        
        .spinner {
            border: 3px solid rgba(212, 175, 55, 0.3);
            border-top: 3px solid #d4af37;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            color: #f44336;
            margin-top: 20px;
        }
        
        .button {
            width: 100%;
            padding: 14px;
            background: #D4AF37;
            color: #000000;
            border: none;
            border-radius: 8px;
            font-family: 'Lato', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .button:hover {
            background: #B8941F;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="https://divin8.com/assets/images/logo/divin8-card-curtains-horizontal.png" alt="Divin8 Logo" onerror="this.style.display='none';">
            <h1>Divin8</h1>
            <p>Mystical Divination</p>
        </div>
        <div id="loadingState">
            <div class="spinner"></div>
            <p style="color: #C0C0C0; font-size: 16px; margin-top: 15px;">Preparing password reset...</p>
        </div>
        <div id="buttonState" class="hidden">
            <p style="margin-bottom: 20px; color: #C0C0C0; font-size: 16px; line-height: 1.5;">Click the button below to continue to password reset:</p>
            <button id="continueButton" class="button">Continue to Password Reset</button>
        </div>
        <div id="error" class="error hidden"></div>
    </div>

    <script>
        // Debug logging configuration - disable in production to prevent localhost popups
        window.__DEBUG_LOGGING_ENABLED__ = false; // Set to false to disable debug logging
        
        // Helper function for debug logging (only logs if enabled)
        function debugLog(location, message, data, hypothesisId) {
            if (!window.__DEBUG_LOGGING_ENABLED__) {
                return; // Logging disabled
            }
            try {
                fetch('http://127.0.0.1:7242/ingest/428b75af-757e-429a-aaa1-d11d73a7516d', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: location,
                        message: message,
                        data: data || {},
                        timestamp: Date.now(),
                        sessionId: 'debug-session',
                        runId: 'run1',
                        hypothesisId: hypothesisId || ''
                    })
                }).catch(function() {});
            } catch (e) {
                // Silently fail
            }
        }
        
        (function() {
            'use strict';
            
            // Extract token from URL query parameters
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            // Detect if this might be Gmail pre-fetch (no user interaction, document not visible)
            const isLikelyPrefetch = document.visibilityState === 'hidden' || 
                                     document.hidden || 
                                     !document.hasFocus() ||
                                     (window.navigator.userAgent.includes('Googlebot') || 
                                      window.navigator.userAgent.includes('Google-InspectionTool'));
            
            // #region agent log
            debugLog('reset-password-intermediate.html:70', 'Intermediate page loaded', {hasToken:!!token,tokenLength:token?token.length:0,currentUrl:window.location.href,visibilityState:document.visibilityState,isHidden:document.hidden,hasFocus:document.hasFocus(),isLikelyPrefetch:isLikelyPrefetch,userAgent:window.navigator.userAgent.substring(0,100)}, 'I');
            // #endregion
            
            if (token) {
                // CRITICAL: Require user interaction (button click) to prevent Gmail pre-fetching
                // Gmail doesn't execute button clicks during pre-fetch, so the code won't be consumed
                console.log('Token found, showing button for user interaction');
                
                // Hide loading, show button
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('buttonState').classList.remove('hidden');
                
                // Handle button click - only redirect when user actually clicks
                document.getElementById('continueButton').addEventListener('click', function() {
                    const clickTime = Date.now();
                    const timeSinceLoad = clickTime - window.__PAGE_LOAD_TIME__;
                    
                    // #region agent log
                    debugLog('reset-password-intermediate.html:88', 'User clicked continue button', {hasToken:!!token,tokenLength:token?token.length:0,timeSinceLoad:timeSinceLoad,visibilityState:document.visibilityState,hasFocus:document.hasFocus()}, 'I');
                    // #endregion
                    
                    // Redirect to reset page with token as code parameter
                    const resetUrl = `https://divin8.com/reset-password.html?code=${encodeURIComponent(token)}`;
                    console.log('User clicked, redirecting to reset page:', resetUrl);
                    
                    // #region agent log
                    debugLog('reset-password-intermediate.html:93', 'Redirecting to reset page after user click', {resetUrl:resetUrl,tokenPrefix:token.substring(0,20)}, 'I');
                    // #endregion
                    
                    window.location.href = resetUrl;
                });
                
                // Store page load time to detect rapid clicks (potential pre-fetch)
                window.__PAGE_LOAD_TIME__ = Date.now();
            } else {
                // No token found - show error
                console.error('No token found in URL');
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('error').textContent = 'Invalid password reset link. Missing token parameter.';
                
                // #region agent log
                debugLog('reset-password-intermediate.html:103', 'No token found in URL', {currentUrl:window.location.href}, 'G');
                // #endregion
            }
        })();
    </script>
</body>
</html>

